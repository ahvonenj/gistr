var columnify=require("columnify"),Client=require("node-rest-client").Client,asyncLoop=require("node-async-loop"),fs=require("fs"),Storage=require("node-storage"),fuzzy=require("fuzzy"),util=require("util"),Private={version:"1.0.8",catchphrases:["because you're worth it","power to the gists","snippety-snap","gistiful!"]},Github={url:"https://api.github.com",default_headers:function(e){var t={"User-Agent":"Gistr v"+Private.version};return void 0!==store.get("access-token")?(consoleLog("Gisting with a saved token",e),t.Authorization="token "+store.get("access-token")):consoleLog("Gisting without saved token",e),t}},client=new Client,store=new Storage(__dirname+"/.gistr_storage"),main=function(){return console.log("Usage: gistr -h")},version=function(){return console.log("gistr v"+Private.version)},help=function(){var e="gistr - "+Private.catchphrases[Math.floor(Math.random()*Private.catchphrases.length)]+"\n\n"+columnify({execdir:"Output current executing directory",moduledir:"Output current module directory"},{columns:["CMD","DESC"]});return console.log(e)},saveToken=function(e){var t=e.t||e.token||null;if(null===t||""===t||0===t.length)return console.log('--token="" not supplied or it is invalid');store.put("access-token",t),console.log("Token saved")},removeToken=function(){if(void 0===store.get("access-token"))return console.log("No token saved");store.remove("access-token"),console.log("Token removed")},showToken=function(){return void 0===store.get("access-token")?console.log("No token saved"):console.log(store.get("access-token"))},creategist=function(e){if(e._=e._.slice(1),0===e._.length&&(console.log("No files specified"),process.exit(0)),e.b||e.bundle||1===e._.length){var t={};consoleLog("Packing file(s) for gist...",e),asyncLoop(e._,function(s,o){fs.lstat(s,function(i,r){if(i){if(i.code="ENOENT")return consoleLog(s+" does not exist, skipping",e),void o();throw i}if(r.isFile()){var n=s;fs.readFile(n,"utf8",function(e,i){if(e)throw e;t[s]={content:i},o()})}else if(r.isDirectory()){console.log("Multiple directories not supported!"),process.exit(1)}else consoleLog(s+" is not a file, skipping",e),o()})},function(s){if(s)console.error(s.message);else if(0===Object.keys(t).length)console.log("No files to gist");else{consoleLog("Files packed",e),consoleLog("Creating a gist...",e);var o={files:t};o.description=e.d||e.desc||e.description||"",o.public=e.p||e.private||!1,client.post(Github.url+"/gists",{data:JSON.stringify(o),headers:Github.default_headers(e)},function(t,s){var o=parseGistResponse(t,!1);-1!==s.headers.status.indexOf("401")?(console.log("Github returned 401 Unauthorized - there might be a problem with your access-token"),process.exit(1)):isRateLimited(o)?(console.log("You have hit the Github rate-limit, try again later"),process.exit(1)):(consoleLog("Files gisted!",e),storeGists(o))})}})}else{var s=[];asyncLoop(e._,function(t,o){consoleLog("Gisting "+t+"...",e),fs.lstat(t,function(i,r){if(i){if(i.code="ENOENT")return consoleLog(t+" does not exist, skipping",e),void o();throw i}if(r.isFile()){var n=t;fs.readFile(n,"utf8",function(t,i){if(t)throw t;var r={files:{}};r.files[n]={content:i},r.description=e.d||e.desc||e.description||"",r.public=e.p||e.private||!1,client.post(Github.url+"/gists",{data:JSON.stringify(r),headers:Github.default_headers(e)},function(t,i){consoleLog("Gisted "+n,e),-1!==i.headers.status.indexOf("401")&&(console.log("Github returned 401 Unauthorized - there might be a problem with your access-token"),process.exit(1)),s.push(parseGistResponse(t)),o()})})}else if(r.isDirectory()){console.log("Multiple directories not supported!"),process.exit(1)}else consoleLog(t+" is not a file, skipping",e),o()})},function(t){t?console.error(t.message):isRateLimited(s)?(console.log("You have hit the Github rate-limit, try again later"),process.exit(1)):(consoleLog("Files gisted!",e),storeGists(s))})}},listGists=function(e,t){if(void 0===t&&void 0===store.get("gists"))return console.log("No gists stored");for(var t=t||store.get("gists"),s=[],o=0;o<t.length;o++){var i=t[o],r={};r["#"]=void 0!==i.idx?i.idx:o,r.desc=i.description,r.created_at=i.created_at,r.auth=i.authenticated;var n=i.files;r.files=Object.keys(n).join("\n"),s.push(r)}return console.log(columnify(s,{preserveNewLines:!0}))},findGist=function(e){if(void 0===store.get("gists"))return console.log("No gists stored");var t=store.get("gists"),s={extract:function(e){return(e.description.length>0?e.description+"|":"")+Object.keys(e.files).join("|")}},o=fuzzy.filter(e._[1],t,s),i=(o.map(function(e){return e.string}),o.map(function(e){return e.original.idx=e.index,e.original}));listGists(null,i)},showGist=function(e){},pullGist=function(e){},parseGistResponse=function(e,t){t=t||!1;try{s=JSON.parse(e)}catch(t){var s=e}var o={};for(var i in s.files)if(s.files.hasOwnProperty(i)){var r=s.files[i];o[i]={filename:r.filename,type:r.type,language:r.language,raw_url:r.raw_url,size:r.size}}var n={id:s.id,url:s.url,html_url:s.html_url,created_at:s.created_at,description:s.description,authenticated:void 0!==s.owner,files:o};return t?JSON.stringify(n):n},isRateLimited=function(e){if(Array.isArray(e)){for(var t=0;t<e.length;t++){var s=e[t];if(0===Object.keys(s.files).length)return!0}return!1}return 0===Object.keys(e.files).length},consoleLog=function(e,t){verbose=t.v||t.verbose||!1,verbose&&console.log(e)},storeGists=function(e){if(void 0===store.get("gists"))Array.isArray(e)?store.put("gists",e):store.put("gists",[e]);else{var t=store.get("gists");if(Array.isArray(e))for(var s=0;s<e.length;s++)t.push(e[s]);else t.push(e);store.put("gists",t)}};exports.main=main,exports.help=help,exports.creategist=creategist,exports.add=creategist,exports.create=creategist,exports.version=version,exports.list=listGists,exports.gists=listGists,exports.find=findGist,exports.search=findGist,exports.show=showGist,exports.details=showGist,exports.pull=pullGist,exports.get=pullGist,exports["save-token"]=saveToken,exports["add-token"]=saveToken,exports["remove-token"]=removeToken,exports["delete-token"]=removeToken,exports["show-token"]=showToken,exports["display-token"]=showToken;