var createGist=function(e,i,t){i=i||!1,t=t||function(){};if(e._=e._.slice(1),0===e._.length&&(console.log("No files specified"),process.exit(0)),e.b||e.bundle||1===e._.length){var s={};consoleLog("Packing file(s) for gist...",e),asyncLoop(e._,function(i,t){fs.lstat(i,function(o,r){if(o){if(o.code="ENOENT")return consoleLog(i+" does not exist, skipping",e),void t();throw o}if(r.isFile()){var n=i,l=path.basename(n);fs.readFile(n,"utf8",function(e,i){if(e)throw e;s[l]={content:i},t()})}else if(r.isDirectory()){console.log("To gist directories, use gist add-dir <directory>"),process.exit(1)}else consoleLog(i+" is not a file, skipping",e),t()})},function(o){if(o)console.error(o.message);else if(0===Object.keys(s).length)console.log("No files to gist");else{consoleLog("Files packed",e),consoleLog("Creating a gist...",e);var r={files:s};r.description=e.d||e.desc||e.description||"",r.public=e.p||e.private||!1,client.post(Github.url+"/gists",{data:JSON.stringify(r),headers:Github.default_headers(e)},function(s,o){var r=parseGistResponse(s,!1);-1!==o.headers.status.indexOf("401")?(console.log("Github returned 401 Unauthorized - there might be a problem with your access-token"),process.exit(1)):isRateLimited(r)?(console.log("You have hit the Github rate-limit, try again later"),process.exit(1)):(consoleLog("Files gisted!",e),i?t(r):storeGists(r))})}})}else{var o=[];asyncLoop(e._,function(i,t){consoleLog("Gisting "+i+"...",e),fs.lstat(i,function(s,r){if(s){if(s.code="ENOENT")return consoleLog(i+" does not exist, skipping",e),void t();throw s}if(r.isFile()){var n=i,l=path.basename(n);fs.readFile(n,"utf8",function(i,s){if(i)throw i;var r={files:{}};r.files[l]={content:s},r.description=e.d||e.desc||e.description||"",r.public=e.p||e.private||!1,client.post(Github.url+"/gists",{data:JSON.stringify(r),headers:Github.default_headers(e)},function(i,s){consoleLog("Gisted "+n,e),-1!==s.headers.status.indexOf("401")&&(console.log("Github returned 401 Unauthorized - there might be a problem with your access-token"),process.exit(1)),o.push(parseGistResponse(i)),t()})})}else if(r.isDirectory()){console.log("To gist directories, use gist add-dir <directory>"),process.exit(1)}else consoleLog(i+" is not a file, skipping",e),t()})},function(s){s?console.error(s.message):isRateLimited(o)?(console.log("You have hit the Github rate-limit, try again later"),process.exit(1)):(consoleLog("Files gisted!",e),i?t(o):storeGists(o))})}},createFolderGist=function(e){e._=e._.slice(1),console.log(e),0===e._.length&&(console.log("No folder specified"),process.exit(0));var i=e._[0];fs.lstat(i,function(t,s){if(t){if(!(t.code="ENOENT"))throw t;consoleLog(i+" does not exist",e),process.exit(1)}s.isDirectory()&&fs.readdir(i,function(t,s){s=s.map(function(e){return i+"/"+e});var o={_:[null].concat(s)};for(var r in e)e.hasOwnProperty(r)&&"_"!==r&&(o[r]=e[r]);o.bundle=!0,o.b=!0,createGist(o)})})},listGists=function(e,i){if(void 0===i&&void 0===store.get("gists"))return console.log("No gists stored");for(var i=i||store.get("gists"),t=[],s=0;s<i.length;s++){var o=i[s],r={};r["#"]=void 0!==o.idx?o.idx:s,r.desc=o.description,r.created_at=o.created_at,r.auth=o.authenticated;var n=o.files;r.files=Object.keys(n).join("\n"),t.push(r)}return console.log(columnify(t,{preserveNewLines:!0}))},findGist=function(e){if(void 0===store.get("gists"))return console.log("No gists stored");var i=store.get("gists"),t={extract:function(e){return(e.description.length>0?e.description+"|":"")+Object.keys(e.files).join("|")}},s=fuzzy.filter(e._[1],i,t),o=(s.map(function(e){return e.string}),s.map(function(e){return e.original.idx=e.index,e.original}));listGists(null,o)},showGist=function(e){var i=getGistOrDie(e),t="";for(var s in i.files)if(i.files.hasOwnProperty(s)){var o=i.files[s];t+="\r\n\r\n\r\n"+o.filename+"\r\n\r\nTYPE: "+o.type+"\r\nLANG: "+o.language+"\r\nRAW: "+o.raw_url+"\r\nSIZE: "+o.size}if(e.tofile){var r="gist-"+i.id+".txt";fs.writeFile(process.cwd()+"/"+r,"ID: "+i.id+"\r\nURL: "+i.url+"\r\nHTML URL: "+i.html_url+"\r\nCREATED: "+i.created_at+"\r\nDESC: "+i.description+"\r\nAUTH: "+i.authenticated+"\r\nFILES: "+t,function(e){if(e)throw e;console.log("Created file "+process.cwd()+"\\"+r)})}else console.log("ID: "+i.id+"\nURL: "+i.url+"\nHTML URL: "+i.html_url+"\nCREATED: "+i.created_at+"\nDESC: "+i.description+"\nAUTH: "+i.authenticated+"\nFILES: "+t)},pullGist=function(e){var i=getGistOrDie(e),t=[];for(var s in i.files)if(i.files.hasOwnProperty(s)){var o=i.files[s];t.push(o)}var r=e.d||e.dir||e.directory||"";r=process.cwd()+"/"+r,mkdirp(r,function(i){i&&(console.error(i),process.exit(1)),asyncLoop(t,function(i,t){download(i.raw_url.toString()).then(function(s){fs.writeFile(r+"/"+i.filename,s,function(s){s&&t(s),consoleLog("Pulled file "+i.filename,e),t()})})},function(i){i?console.error(i.message):consoleLog("Gist pulled",e)})})};exports.wrap=function(e){e.createGist=createGist,e.createFolderGist=createFolderGist,e.listGists=listGists,e.findGist=findGist,e.showGist=showGist,e.pullGist=pullGist};