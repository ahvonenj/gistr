var createGist=function(e,s,i){s=s||!1,i=i||function(){};if(e._=e._.slice(1),0===e._.length&&(console.log("No files specified"),process.exit(0)),e.b||e.bundle||1===e._.length){var t={};consoleLog("Packing file(s) for gist...",e),asyncLoop(e._,function(s,i){fs.lstat(s,function(o,n){if(o){if(o.code="ENOENT")return consoleLog(s+" does not exist, skipping",e),void i();throw o}if(n.isFile()){var r=s,l=path.basename(r);fs.readFile(r,"utf8",function(e,s){if(e)throw e;t[l]={content:s},i()})}else if(n.isDirectory()){console.log("To gist directories, use gist add-dir <directory>"),process.exit(1)}else consoleLog(s+" is not a file, skipping",e),i()})},function(o){if(o)console.error(o.message);else if(0===Object.keys(t).length)console.log("No files to gist");else{consoleLog("Files packed",e),consoleLog("Creating a gist...",e);var n={files:t};n.description=e.d||e.desc||e.description||"",n.public=e.p||e.private||!1,client.post(Github.url+"/gists",{data:JSON.stringify(n),headers:Github.default_headers(e)},function(t,o){var n=parseGistResponse(t,!1);-1!==o.headers.status.indexOf("401")?(console.log("Github returned 401 Unauthorized - there might be a problem with your access-token"),process.exit(1)):-1===o.headers.status.indexOf("200")?(console.log("Unknown response ("+o.headers.status+")"),process.exit(1)):isRateLimited(n)?(console.log("You have hit the Github rate-limit, try again later"),process.exit(1)):(consoleLog("Files gisted!",e),s?i(n):storeGists(n))})}})}else{var o=[];asyncLoop(e._,function(s,i){consoleLog("Gisting "+s+"...",e),fs.lstat(s,function(t,n){if(t){if(t.code="ENOENT")return consoleLog(s+" does not exist, skipping",e),void i();throw t}if(n.isFile()){var r=s,l=path.basename(r);fs.readFile(r,"utf8",function(s,t){if(s)throw s;var n={files:{}};n.files[l]={content:t},n.description=e.d||e.desc||e.description||"",n.public=e.p||e.private||!1,client.post(Github.url+"/gists",{data:JSON.stringify(n),headers:Github.default_headers(e)},function(s,t){consoleLog("Gisted "+r,e),-1!==t.headers.status.indexOf("401")?(console.log("Github returned 401 Unauthorized - there might be a problem with your access-token"),process.exit(1)):-1===t.headers.status.indexOf("200")&&(console.log("Unknown response ("+t.headers.status+")"),process.exit(1)),o.push(parseGistResponse(s)),i()})})}else if(n.isDirectory()){console.log("To gist directories, use gist add-dir <directory>"),process.exit(1)}else consoleLog(s+" is not a file, skipping",e),i()})},function(t){t?console.error(t.message):isRateLimited(o)?(console.log("You have hit the Github rate-limit, try again later"),process.exit(1)):(consoleLog("Files gisted!",e),s?i(o):storeGists(o))})}},createFolderGist=function(e){e._=e._.slice(1),console.log(e),0===e._.length&&(console.log("No folder specified"),process.exit(0));var s=e._[0];fs.lstat(s,function(i,t){if(i){if(!(i.code="ENOENT"))throw i;consoleLog(s+" does not exist",e),process.exit(1)}t.isDirectory()&&fs.readdir(s,function(i,t){t=t.map(function(e){return s+"/"+e});var o={_:[null].concat(t)};for(var n in e)e.hasOwnProperty(n)&&"_"!==n&&(o[n]=e[n]);o.bundle=!0,o.b=!0,createGist(o)})})},listGists=function(e,s){if(void 0===s&&void 0===store.get("gists"))return console.log("No gists stored");for(var s=s||store.get("gists"),i=[],t=0;t<s.length;t++){var o=s[t],n={};n["#"]=void 0!==o.idx?o.idx:t,n.desc=o.description,n.created_at=o.created_at,n.auth=o.authenticated;var r=o.files;n.files=Object.keys(r).join("\n"),i.push(n)}return console.log(columnify(i,{preserveNewLines:!0}))},findGist=function(e){if(void 0===store.get("gists"))return console.log("No gists stored");var s=store.get("gists"),i={extract:function(e){return(e.description.length>0?e.description+"|":"")+Object.keys(e.files).join("|")}},t=fuzzy.filter(e._[1],s,i),o=(t.map(function(e){return e.string}),t.map(function(e){return e.original.idx=e.index,e.original}));listGists(null,o)},showGist=function(e){var s=getGistOrDie(e),i="";for(var t in s.files)if(s.files.hasOwnProperty(t)){var o=s.files[t];i+="\r\n\r\n\r\n"+o.filename+"\r\n\r\nTYPE: "+o.type+"\r\nLANG: "+o.language+"\r\nRAW: "+o.raw_url+"\r\nSIZE: "+o.size}if(e.tofile){var n="gist-"+s.id+".txt";fs.writeFile(process.cwd()+"/"+n,"ID: "+s.id+"\r\nURL: "+s.url+"\r\nHTML URL: "+s.html_url+"\r\nCREATED: "+s.created_at+"\r\nDESC: "+s.description+"\r\nAUTH: "+s.authenticated+"\r\nFILES: "+i,function(e){if(e)throw e;console.log("Created file "+process.cwd()+"\\"+n)})}else console.log("ID: "+s.id+"\nURL: "+s.url+"\nHTML URL: "+s.html_url+"\nCREATED: "+s.created_at+"\nDESC: "+s.description+"\nAUTH: "+s.authenticated+"\nFILES: "+i)},pullGist=function(e){var s=getGistOrDie(e),i=[];for(var t in s.files)if(s.files.hasOwnProperty(t)){var o=s.files[t];i.push(o)}var n=e.d||e.dir||e.directory||"";n=process.cwd()+"/"+n,mkdirp(n,function(s){s&&(console.error(s),process.exit(1)),asyncLoop(i,function(s,i){download(s.raw_url.toString()).then(function(t){fs.writeFile(n+"/"+s.filename,t,function(t){t&&i(t),consoleLog("Pulled file "+s.filename,e),i()})})},function(s){s?console.error(s.message):consoleLog("Gist pulled",e)})})},pullGistById=function(e,s){consoleLog("Pulling gist "+e,s),client.get(Github.url+"/gists/"+e,{headers:Github.default_headers(s)},function(i,t){-1!==t.headers.status.indexOf("404")?(console.log("Github returned 404 Not Found - there might be a problem with the supplied Gist ID"),process.exit(1)):-1===t.headers.status.indexOf("200")&&(console.log("Unknown response ("+t.headers.status+")"),process.exit(1)),consoleLog("Pulled gist "+e,s);var o=parseGistResponse(i,!1),n=o.files[Object.keys(o.files)[0]].raw_url;console.log(n)})};exports.wrap=function(e){e.createGist=createGist,e.createFolderGist=createFolderGist,e.listGists=listGists,e.findGist=findGist,e.showGist=showGist,e.pullGist=pullGist,e.pullGistById=pullGistById};